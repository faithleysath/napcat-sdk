import inspect
import re
import sys
from pathlib import Path
from typing import Any

try:
    from napcat.types import schemas
except ImportError:
    print("âŒ æ— æ³•å¯¼å…¥ src.napcat.types.schemas")
    sys.exit(1)

schema_json = {}

try:
    import json
    with open("schema.openapi.json", "r", encoding="utf-8") as f:
        schema_json = json.load(f)
        schema_json: dict[str, Any] = schema_json.get("paths", {})
except Exception as e:
    print(f"âŒ æ— æ³•åŠ è½½ schema.openapi.json: {e}")

def to_snake_case(name: str) -> str:
    # ç¬¬ä¸€æ­¥ï¼šæŠŠ "HTTPResponse" å˜æˆ "HTTP_Response"
    # é€»è¾‘ï¼šæ‰¾åˆ°éé¦–å­—æ¯çš„å­—ç¬¦ï¼Œåé¢è·Ÿç€"ä¸€ä¸ªå¤§å†™+å°å†™åºåˆ—"ï¼Œåœ¨å®ƒä»¬ä¸­é—´åŠ ä¸‹åˆ’çº¿
    s1 = re.sub('(.)([A-Z][a-z]+)', r'\1_\2', name)
    
    # ç¬¬äºŒæ­¥ï¼šæŠŠ "UserIdentifier" å˜æˆ "User_Identifier"
    # é€»è¾‘ï¼šæ‰¾åˆ°"å°å†™æˆ–æ•°å­—"ï¼Œåé¢è·Ÿç€"ä¸€ä¸ªå¤§å†™"ï¼Œåœ¨å®ƒä»¬ä¸­é—´åŠ ä¸‹åˆ’çº¿
    return re.sub('([a-z0-9])([A-Z])', r'\1_\2', s1).lower()

def generate_mixin():
    print("ğŸ”„ æ­£åœ¨ç”Ÿæˆ Mixin ç±» (src/napcat/client_gen.py) ...")
    
    methods_code: list[str] = []
    used_schema_types: set[str] = set()
    
    # éå† schemas
    class_names = [name for name, _ in inspect.getmembers(schemas, inspect.isclass)]
    
    for name in class_names:
        if not name.endswith("PostRequest"):
            continue
        
        used_schema_types.add(name)
        # å°† SendGroupMsgPostRequest -> send_group_msg
        base_name = name[:-11]
        if f"/{base_name}" in schema_json:
            method_name = base_name
        else:
            method_name = to_snake_case(base_name)
        
        # å¯»æ‰¾å¯¹åº”çš„ Response ç±»
        response_class_name = f"{base_name}PostResponse"
        if response_class_name not in class_names:
            return_type = "dict[str, Any]"
        else:
            return_type = response_class_name
            used_schema_types.add(response_class_name)

        # æŸ¥æ‰¾æ³¨é‡Š
        method_json = schema_json.get(f"/{method_name}", {}).get("post", {})
        if method_json:
            description = method_json.get("summary", "")
            tag = method_json.get("tags", [""])[0]
            docstring = f'        """\n        {description}\n\n        æ ‡ç­¾: {tag}\n        """'
        else:
            docstring = '        """\n        æœªæä¾›æè¿°ã€‚\n        """'

        # æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆå®é™…çš„å‡½æ•°ä½“
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬å‡è®¾ params å°±æ˜¯ kwargsï¼Œç›´æ¥ä¼ ç»™ call_action
        code_block = f"""
    async def {method_name}(self, **kwargs: Unpack[{name}]) -> {return_type}:
{docstring}
        return await self.call_action("{method_name}", kwargs)
"""
        methods_code.append(code_block)

    # === ç”Ÿæˆå¯¼å…¥è¯­å¥å— ===
    # æ’åºä»¥ä¿è¯ç”Ÿæˆçš„ä»£ç ç¨³å®š
    sorted_types = sorted(list(used_schema_types))
    
    # æ ¼å¼åŒ–å¯¼å…¥å­—ç¬¦ä¸²ï¼Œçœ‹èµ·æ¥æ›´æ•´æ´
    import_lines = ["from .types.schemas import ("]
    for type_name in sorted_types:
        import_lines.append(f"    {type_name},")
    import_lines.append(")")
    
    schema_imports_str = "\n".join(import_lines)

    # ç”Ÿæˆæ–‡ä»¶å†…å®¹
    content = f"""# generated by generate_client_gen.py
# ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œè¯·è¿è¡Œç”Ÿæˆè„šæœ¬æ›´æ–°ã€‚

from typing import Any, Unpack, Mapping
{schema_imports_str}


class NapCatClientGenerated:
    \"\"\"
    è¿™æ˜¯ NapCatClient çš„è‡ªåŠ¨ç”ŸæˆåŸºç±»ã€‚
    å®ƒåŒ…å«äº†æ‰€æœ‰ä» OpenAPI Schema è§£æå‡ºçš„æ˜¾å¼ API æ–¹æ³•ã€‚
    \"\"\"

    async def call_action(self, action: str, params: Mapping[str, Any] | None = None) -> Any:
        \"\"\"
        å­ç±»å¿…é¡»å®ç°æ­¤æ–¹æ³•ã€‚
        \"\"\"
        raise NotImplementedError("NapCatClient å¿…é¡»å®ç° call_action")

{ "".join(methods_code) }
"""

    output_path = Path("src/napcat/client_gen.py")
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(content)

    print(f"âœ… ç”Ÿæˆå®Œæˆï¼š{output_path} ({len(methods_code)} ä¸ªæ–¹æ³•)")

if __name__ == "__main__":
    generate_mixin()